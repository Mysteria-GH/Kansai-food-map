<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>美食特輯地圖 京阪ver.</title>
    
    <!-- iOS PWA 專用設定 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="美食特輯地圖 京阪ver.">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/854/854878.png">
    
    <!-- Android PWA / 瀏覽器專用設定 -->
    <meta name="theme-color" content="#ffffff">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="icon" sizes="192x192" href="https://cdn-icons-png.flaticon.com/512/854/854878.png">
    <link rel="shortcut icon" href="https://cdn-icons-png.flaticon.com/512/854/854878.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .btn-active:active { transform: scale(0.98); }
        
        /* 卷軸動畫樣式 */
        .accordion-content {
            transition: max-height 0.4s ease-in-out, opacity 0.4s ease-in-out;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
        }
        .accordion-content.open {
            max-height: 500px; /* 足夠大的高度以容納內容 */
            opacity: 1;
        }
    </style>
    
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- React & ReactDOM & Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>

    <style>
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .leaflet-container { width: 100%; height: 100%; z-index: 0; }
        body { overscroll-behavior-y: none; -webkit-tap-highlight-color: transparent; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans h-screen w-screen overflow-hidden">
    <div id="root" class="h-full w-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Icons ---
        const IconSearch = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>;
        const IconMapPin = ({className}) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>;
        const IconTrash = () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>;
        const IconArrowRight = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>;
        const IconArrowLeft = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>;
        const IconDownload = () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>;
        const IconChevronDown = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>;
        const IconChevronUp = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg>;
        const IconChevronLeft = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>;
        const IconChevronRight = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>;
        const IconStar = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>;
        const IconFilter = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>;

        // --- Constants ---
        const LOCATIONS = {
            kyoto: { name: "京都車站", lat: 34.9858, lng: 135.7588, color: "bg-indigo-600" },
            osaka: { name: "大阪梅田", lat: 34.7025, lng: 135.4958, color: "bg-rose-600" } 
        };

        const OSAKA_SUBLOCATIONS = {
            umeda: { id: 'umeda', name: "大阪梅田", lat: 34.7025, lng: 135.4958 },
            shinsaibashi: { id: 'shinsaibashi', name: "心齋橋", lat: 34.6723, lng: 135.5013 },
            namba: { id: 'namba', name: "大阪難波", lat: 34.6655, lng: 135.5010 }
        };

        const FOOD_TYPES = [
            { id: 'ramen', label: '拉麵' },
            { id: 'sukiyaki', label: '壽喜燒' },
            { id: 'yakiniku', label: '燒肉' },
            { id: 'sushi', label: '壽司' },
            { id: 'ricebowl', label: '丼飯' },
            { id: 'hamburger', label: '漢堡排' },
            { id: 'cafe', label: '咖啡廳' },
            { id: 'other', label: '其它' }
        ];

        const FILTER_TYPES = [
            { id: 'all', label: '所有種類' },
            ...FOOD_TYPES
        ];

        const DISTANCE_TYPES = [
            { id: 'all', label: 'All' },
            { id: 'near', label: '≤ 1 KM' },
            { id: 'far', label: '> 1 KM' }
        ];

        // 特徵篩選
        const SPECIAL_TYPES = [
            { id: 'wagyu', label: '和牛' },
            { id: 'other_feature', label: '其它' }
        ];

        // --- 系統推薦店鋪資料 ---
        const SYSTEM_SHOPS = [
            { id: 1, name: "花丸軒 法善寺店(道頓堀+24小時+濃郁豚骨醬油+魯豬五花叉燒+蒜片+炒飯+煎餃)", displayName: "花丸軒 法善寺店", lat: 34.6675, lng: 135.5028, category: "osaka", type: ["ramen"], address: "道頓堀/法善寺" },
            { id: 2, name: "しゃぶしゃぶ・すき焼き専門店 しゃぶ長(心齋橋+中午套餐+和牛壽喜燒)", displayName: "しゃぶ長", lat: 34.6728, lng: 135.5013, category: "osaka", type: ["sukiyaki"], address: "心齋橋" },
            { id: 3, name: "お食事処 美登里(大阪豬排丼+量大)", displayName: "お食事処 美登里", lat: 34.6695, lng: 135.5496, category: "osaka", type: ["ricebowl"], address: "大阪東成區" },
            { id: 4, name: "Melt Chocolate(心齋橋+現切熱巧克力)", displayName: "Melt Chocolate", lat: 34.6775, lng: 135.4993, category: "osaka", type: ["cafe", "other"], address: "心齋橋/南船場" },
            { id: 5, name: "大阪燒 千房(道頓堀)", displayName: "千房 道頓堀", lat: 34.6685, lng: 135.5035, category: "osaka", type: ["other"], address: "道頓堀" },
            { id: 6, name: "肉の隠れ家 おあがり 嵐山本店(和牛火山+桂川風景)", displayName: "肉の隠れ家 おあがり", lat: 35.0116, lng: 135.6766, category: "kyoto", type: ["ricebowl", "other"], address: "嵐山" },
            { id: 7, name: "すきやき・しゃぶしゃぶ大牧場 千日前店(難波站+神戶和牛壽喜燒吃到飽)", displayName: "大牧場 千日前店", lat: 34.6667, lng: 135.5042, category: "osaka", type: ["sukiyaki"], address: "千日前/難波" },
            { id: 8, name: "焼肉こじま離れ 大阪江坂(漢堡排)", displayName: "焼肉こじま離れ", lat: 34.7595, lng: 135.4965, category: "osaka", type: ["yakiniku", "hamburger"], address: "江坂" },
            { id: 9, name: "厚切り仙台牛タンと黒毛和牛食べ放題 焼肉倶楽部 梅田店", displayName: "焼肉倶楽部 梅田店", lat: 34.7035, lng: 135.5000, category: "osaka", type: ["yakiniku"], address: "梅田" },
            { id: 10, name: "しゃぶ禅 梅田店(黑毛和牛壽喜燒吃到飽)", displayName: "しゃぶ禅 梅田店", lat: 34.7005, lng: 135.4965, category: "osaka", type: ["sukiyaki"], address: "梅田" },
            { id: 11, name: "焼肉ジャパン LINKS UMEDA店(梅田+神戶牛)", displayName: "焼肉ジャパン", lat: 34.7050, lng: 135.4970, category: "osaka", type: ["yakiniku"], address: "LINKS UMEDA" },
            { id: 12, name: "すき焼 しゃぶしゃぶつかだ KITTE大阪(梅田kitte百貨+關西和牛壽喜燒)", displayName: "すき焼 しゃぶしゃぶつかだ", lat: 34.7015, lng: 135.4945, category: "osaka", type: ["sukiyaki"], address: "KITTE大阪" },
            { id: 13, name: "和牛一頭買い 焼肉ホルモン黒野 ウラなんば本店(難波+黑毛和牛)", displayName: "焼肉ホルモン黒野", lat: 34.6645, lng: 135.5030, category: "osaka", type: ["yakiniku"], address: "裏難波" },
            { id: 14, name: "手づくりハンバーグの店 とくら 京都三条店(Juicy Hamburger Steak+ルクア大阪也有)", displayName: "とくら 京都三条店", lat: 35.0089, lng: 135.7681, category: "kyoto", type: ["hamburger"], address: "京都三条" },
            { id: 15, name: "板前焼肉 一光 住之江本店(黑毛和牛)", displayName: "板前焼肉 一光", lat: 34.6094, lng: 135.4735, category: "osaka", type: ["yakiniku"], address: "住之江" },
            { id: 16, name: "TAKUMEAT STORE(新大阪站+燒肉)", displayName: "TAKUMEAT STORE", lat: 34.7335, lng: 135.5003, category: "osaka", type: ["yakiniku"], address: "新大阪" },
            { id: 17, name: "地焼うなぎ 法善寺山かづ(難波站+關西地燒鰻魚飯)", displayName: "法善寺山かづ", lat: 34.6672, lng: 135.5020, category: "osaka", type: ["other"], address: "法善寺" },
            { id: 18, name: "黄金出汁しゃぶと江戸前寿司 肉のあさつ 梅田お初天神店(梅田+黑毛和牛壽喜燒定食+免費白飯?+特定時間)", displayName: "肉のあさつ", lat: 34.7000, lng: 135.5015, category: "osaka", type: ["sukiyaki", "sushi"], address: "梅田お初天神" },
            { id: 19, name: "スキヤキフジオ なんばCITY店(難波+個人壽喜燒)", displayName: "スキヤキフジオ", lat: 34.6642, lng: 135.5025, category: "osaka", type: ["sukiyaki"], address: "難波CITY" },
            { id: 20, name: "焼肉ごりちゃんお初天神店(東梅田+黑毛和牛)", displayName: "焼肉ごりちゃん", lat: 34.7010, lng: 135.5010, category: "osaka", type: ["yakiniku"], address: "東梅田" },
            { id: 21, name: "CAFE ANNON なんば本店(難波+鬆餅?)", displayName: "CAFE ANNON", lat: 34.6660, lng: 135.5035, category: "osaka", type: ["cafe", "other"], address: "難波" },
            { id: 22, name: "和牛専門 牛めし 前田優(難波+A5和牛+牛丼)", displayName: "和牛専門 牛めし 前田優", lat: 34.6670, lng: 135.5060, category: "osaka", type: ["ricebowl"], address: "千日前/日本橋" },
            { id: 23, name: "釜飯と海鮮 暁(心齋橋+創作海鮮+海鮮釜飯)", displayName: "釜飯と海鮮 暁", lat: 34.6735, lng: 135.5020, category: "osaka", type: ["ricebowl", "other"], address: "心齋橋" },
            { id: 24, name: "かつ丼 千代松豪仁(四ツ橋駅)", displayName: "かつ丼 千代松豪仁", lat: 34.6729, lng: 135.4966, category: "osaka", type: ["ricebowl"], address: "四ツ橋" },
            { id: 25, name: "厚切り仙台牛タンと黒毛和牛食べ放題 焼肉倶楽部 天王寺店", displayName: "焼肉倶楽部 天王寺店", lat: 34.6478, lng: 135.5148, category: "osaka", type: ["yakiniku"], address: "天王寺" },
            { id: 26, name: "＃KOKUBAN (コクバン)(歐姆飯+漢堡排)", displayName: "KOKUBAN", lat: 34.6650, lng: 135.5000, category: "osaka", type: ["hamburger", "other"], address: "難波/心齋橋" },
            { id: 27, name: "焼き鳥 おでん 坊っちゃん茶屋町店(梅田+平價串燒+昭和風?)", displayName: "坊っちゃん茶屋町店", lat: 34.7070, lng: 135.4990, category: "osaka", type: ["other"], address: "梅田茶屋町" },
            { id: 28, name: "焼肉 㐂舌 法善寺(午間定食+牛蓋飯+茶泡飯+包間)", displayName: "焼肉 㐂舌", lat: 34.6675, lng: 135.5030, category: "osaka", type: ["yakiniku", "ricebowl"], address: "法善寺" },
            { id: 29, name: "帰ってきた 宮田麺児(沾麵)", displayName: "帰ってきた 宮田麺児", lat: 34.6720, lng: 135.5035, category: "osaka", type: ["ramen"], address: "心齋橋" },
            { id: 30, name: "まるよし(木津壽司)", displayName: "まるよし", lat: 34.6569, lng: 135.4984, category: "osaka", type: ["sushi"], address: "木津市場" },
            { id: 31, name: "焼肉うしごろ 梅田店(和牛燒肉+全程代烤)", displayName: "焼肉うしごろ", lat: 34.7040, lng: 135.4960, category: "osaka", type: ["yakiniku"], address: "梅田" },
            { id: 32, name: "大和茶大福專門店 GRAN CHA(奈良+大福)", displayName: "GRAN CHA", lat: 34.6815, lng: 135.8290, category: "osaka", type: ["cafe", "other"], address: "奈良" },
            { id: 33, name: "中谷堂(奈良+艾草麻糬)", displayName: "中谷堂", lat: 34.6820, lng: 135.8298, category: "osaka", type: ["other"], address: "奈良" },
            { id: 34, name: "三大和牛食べ比べ 焼肉 つなぐ(難波+個室燒肉+神戶牛)", displayName: "焼肉 つなぐ", lat: 34.6660, lng: 135.5020, category: "osaka", type: ["yakiniku"], address: "難波" },
            { id: 35, name: "すき焼き しゃぶしゃぶ 肉寿司 食べ放題 和牛ざんまい 心斎橋店(宮崎牛壽喜燒+串燒+吃到飽+四種套餐)", displayName: "和牛ざんまい", lat: 34.6715, lng: 135.5015, category: "osaka", type: ["sukiyaki", "sushi"], address: "心齋橋" },
            { id: 36, name: "すき焼き・しゃぶしゃぶ きよ助(個人鍋)", displayName: "きよ助", lat: 34.6690, lng: 135.5010, category: "osaka", type: ["sukiyaki"], address: "難波" },
            { id: 37, name: "大阪福島 WAgyu鬼く 焼肉(新福島站+黑毛和牛+冷麵)", displayName: "WAgyu鬼く", lat: 34.6967, lng: 135.4800, category: "osaka", type: ["yakiniku"], address: "福島" },
            { id: 38, name: "人類みな麵類(應該是這家?+西中島+18~22+炒飯+醬油拉麵+鮭魚卵)", displayName: "人類みな麵類", lat: 34.7262, lng: 135.5005, category: "osaka", type: ["ramen"], address: "西中島南方" },
            { id: 39, name: "牛舌的柠檬(超厚碳烤牛舌+牛舌後段[軟嫩]+味噌醬+檸檬飲+咖哩牛舌+免費續飯)", displayName: "牛たんの檸檬 大阪", lat: 34.6665, lng: 135.5040, category: "osaka", type: ["yakiniku"], address: "難波/日本橋" },
            { id: 40, name: "やさい串巻き なるとや(應該是這家?+野菜捲+居酒屋)", displayName: "なるとや", lat: 34.6680, lng: 135.5025, category: "osaka", type: ["other"], address: "難波" },
            { id: 41, name: "MooM Cafe(舒芙蕾煎餅)", displayName: "MooM Cafe", lat: 34.8517, lng: 135.6178, category: "osaka", type: ["cafe", "other"], address: "高槻" },
            { id: 42, name: "黒毛和牛タンとハラミ 焼肉龍 難波千日前店(黑毛和牛燒肉+螃蟹海鮮+吃到飽)", displayName: "焼肉龍", lat: 34.6655, lng: 135.5038, category: "osaka", type: ["yakiniku"], address: "千日前" },
            { id: 43, name: "めん処 つるはん KITTE大阪店(西梅田站+黑毛和牛+壽喜燒烏龍麵)", displayName: "めん処 つるはん", lat: 34.7015, lng: 135.4945, category: "osaka", type: ["sukiyaki"], address: "KITTE大阪" },
            { id: 44, name: "パンとエスプレッソと堺筋俱楽部(Brunch+百年銀行+麵包咖啡廳+一個月前預約)", displayName: "堺筋俱楽部", lat: 34.6750, lng: 135.5065, category: "osaka", type: ["cafe", "other"], address: "堺筋" },
            { id: 45, name: "らーめん志高(豚骨+炒飯+座位少)", displayName: "らーめん志高", lat: 34.6019, lng: 135.4920, category: "osaka", type: ["ramen"], address: "住吉" },
            { id: 46, name: "The 33 Tea＆Bar Terrace(梅田+絕景+歐姆飯+午間套餐)", displayName: "The 33", lat: 34.6995, lng: 135.4930, category: "osaka", type: ["cafe", "other"], address: "西梅田" }
        ];

        // --- Helper: Distance Calculation ---
        const getDistance = (lat1, lon1, lat2, lon2) => {
            const R = 6371; 
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2); 
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
            return R * c;
        };

        // --- Helper: Get labels from IDs ---
        const getFoodTypeLabels = (typeIds) => {
            const ids = Array.isArray(typeIds) ? typeIds : [typeIds || 'other'];
            return ids.map(id => {
                const found = FOOD_TYPES.find(t => t.id === id);
                return found ? found.label : '其它';
            });
        };

        // --- Component: MapView ---
        function MapView({ center, shops }) {
            const mapContainerRef = useRef(null);
            const mapInstanceRef = useRef(null);
            const markersRef = useRef([]);

            useEffect(() => {
                if (!mapContainerRef.current) return;
                
                delete L.Icon.Default.prototype._getIconUrl;
                L.Icon.Default.mergeOptions({
                    iconRetinaUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png',
                    iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
                    shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
                });

                const map = L.map(mapContainerRef.current).setView([center.lat, center.lng], 13);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; OpenStreetMap contributors'
                }).addTo(map);

                const centerIcon = new L.Icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-gold.png',
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34],
                    shadowSize: [41, 41]
                });

                L.marker([center.lat, center.lng], { icon: centerIcon })
                    .bindPopup(`<b>${center.name}</b> (中心)`)
                    .addTo(map);

                mapInstanceRef.current = map;

                return () => {
                    map.remove();
                    mapInstanceRef.current = null;
                };
            }, []); 

            useEffect(() => {
                if (!mapInstanceRef.current) return;
                const map = mapInstanceRef.current;

                map.eachLayer((layer) => {
                    if (layer instanceof L.Marker && layer.getIcon().options.iconUrl.includes('gold')) {
                         layer.setLatLng([center.lat, center.lng])
                              .setPopupContent(`<b>${center.name}</b> (中心)`)
                              .openPopup();
                    }
                });

                markersRef.current.forEach(m => m.remove());
                markersRef.current = [];

                const points = [[center.lat, center.lng]];

                shops.forEach(shop => {
                    points.push([shop.lat, shop.lng]);

                    const labels = getFoodTypeLabels(shop.type);
                    const tagsHtml = labels.map(label => 
                        `<span style="font-size: 11px; background-color: #f3f4f6; padding: 2px 6px; border-radius: 4px; border: 1px solid #e5e7eb; color: #4b5563; display: inline-block; margin-right: 4px; margin-bottom: 2px;">${label}</span>`
                    ).join('');

                    const popupContent = `
                        <div class="p-1">
                            <h3 class="font-bold text-base mb-1">${shop.name}</h3>
                            <div class="mb-2" style="display: flex; flex-wrap: wrap;">
                                ${tagsHtml}
                            </div>
                            <p class="text-xs text-gray-600 mb-2">${shop.address || '無地址資訊'}</p>
                            <a href="https://maps.google.com/?q=${shop.lat},${shop.lng}" 
                               target="_blank" 
                               style="color: #2563eb; text-decoration: none; font-size: 12px; display: flex; align-items: center; gap: 4px;">
                               ➤ 開啟 Google Maps 導航
                            </a>
                        </div>
                    `;

                    const marker = L.marker([shop.lat, shop.lng])
                        .bindPopup(popupContent)
                        .addTo(map);
                    markersRef.current.push(marker);
                });

                if (shops.length > 0) {
                    const bounds = L.latLngBounds(points);
                    map.fitBounds(bounds, {
                        padding: [50, 50],
                        maxZoom: 16,
                        animate: true,
                        duration: 1.0
                    });
                } else {
                    map.flyTo([center.lat, center.lng], 13, { duration: 1.0 });
                }

            }, [center, shops]);

            return <div ref={mapContainerRef} className="h-full w-full"></div>;
        }

        // --- Main App Component ---
        function App() {
            // ========================================================
            // ★★★ 核心資料儲存程式碼：初始化 (讀取紀錄 - 只讀取使用者資料) ★★★
            // ========================================================
            const [userShops, setUserShops] = useState(() => {
                const saved = localStorage.getItem('kansai_shops');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    return parsed.filter(s => s.id > 10000); 
                }
                return []; 
            });

            // ========================================================
            // ★★★ 核心資料儲存程式碼：更新 (寫入紀錄 - 只寫入使用者資料) ★★★
            // ========================================================
            useEffect(() => {
                localStorage.setItem('kansai_shops', JSON.stringify(userShops));
            }, [userShops]);
            // ========================================================

            const [inputName, setInputName] = useState('');
            const [inputType, setInputType] = useState(['other']); 
            const [activeTab, setActiveTab] = useState('add');
            
            const [listTab, setListTab] = useState('my'); 

            const [mapCategory, setMapCategory] = useState('kyoto');
            const [osakaSubLocation, setOsakaSubLocation] = useState('umeda');
            const [mapFilterType, setMapFilterType] = useState('all'); 
            const [mapFilterDistance, setMapFilterDistance] = useState('all');
            
            // 和牛/其它 特殊篩選 (空陣列=全選)
            const [mapFilterSpecial, setMapFilterSpecial] = useState([]);
            
            // 詳細選單開關
            const [isDetailMenuOpen, setIsDetailMenuOpen] = useState(true);

            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            
            const [showList, setShowList] = useState(true);
            
            // 分頁狀態
            const [currentPage, setCurrentPage] = useState(1);
            const ITEMS_PER_PAGE = 5;

            const currentCenter = useMemo(() => {
                if (mapCategory === 'kyoto') {
                    return LOCATIONS.kyoto;
                } else {
                    return OSAKA_SUBLOCATIONS[osakaSubLocation] || LOCATIONS.osaka;
                }
            }, [mapCategory, osakaSubLocation]);

            const handleInputTypeClick = (id) => {
                if (id === 'other') {
                    setInputType(['other']);
                } else {
                    let newTypes;
                    if (inputType.includes('other') && inputType.length === 1) {
                        newTypes = [id];
                    } else {
                        if (inputType.includes(id)) {
                            newTypes = inputType.filter(t => t !== id);
                        } else {
                            newTypes = [...inputType, id];
                        }
                    }
                    if (newTypes.length === 0) {
                        newTypes = ['other'];
                    }
                    setInputType(newTypes);
                }
            };

            const handleAddShop = async () => {
                if (!inputName.trim()) return;
                setLoading(true);
                setError(null);

                const searchName = inputName.split(/[\(（]/)[0].trim();

                try {
                    const response = await fetch(
                        `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchName + ' 日本')}&limit=1`
                    );
                    const data = await response.json();

                    if (data && data.length > 0) {
                        const place = data[0];
                        const lat = parseFloat(place.lat);
                        const lng = parseFloat(place.lon);

                        const distToKyoto = getDistance(lat, lng, LOCATIONS.kyoto.lat, LOCATIONS.kyoto.lng);
                        const distToOsaka = getDistance(lat, lng, LOCATIONS.osaka.lat, LOCATIONS.osaka.lng);
                        
                        const category = distToKyoto < distToOsaka ? 'kyoto' : 'osaka';

                        const newShop = {
                            id: Date.now(),
                            name: inputName, 
                            displayName: place.display_name.split(',')[0],
                            lat,
                            lng,
                            category,
                            type: inputType, 
                            address: place.display_name
                        };

                        setUserShops([newShop, ...userShops]);
                        setInputName('');
                        
                        setListTab('my');
                        setShowList(true);
                        setCurrentPage(1);
                    } else {
                        setError('找不到該店舖，請嘗試更精確的名稱，或確認括號位置是否正確。');
                    }
                } catch (err) {
                    setError('搜尋時發生錯誤，請檢查網路連線。');
                } finally {
                    setLoading(false);
                }
            };

            const handleDelete = (id) => {
                setUserShops(userShops.filter(shop => shop.id !== id));
            };

            const handleExport = () => {
                const dataStr = JSON.stringify(userShops);
                navigator.clipboard.writeText(dataStr).then(() => {
                    alert("✅ 個人資料已複製！");
                }).catch(err => {
                    console.error('複製失敗:', err);
                });
            };

            const allShopsForMap = useMemo(() => {
                return [...userShops, ...SYSTEM_SHOPS];
            }, [userShops]);

            const checkIsWagyu = (shop) => {
                const text = (shop.name || '') + (shop.displayName || '');
                const keywords = ['和牛', 'Wagyu', '神戶牛', '神戸牛', '但馬牛', '近江牛', '宮崎牛', '仙台牛', '黒毛', '黑毛', '牛舌'];
                return keywords.some(k => text.includes(k));
            };

            const filteredShops = useMemo(() => {
                return allShopsForMap.filter(shop => {
                    const matchLocation = shop.category === mapCategory;
                    
                    const shopTypes = Array.isArray(shop.type) ? shop.type : [shop.type || 'other'];
                    const matchType = mapFilterType === 'all' || shopTypes.includes(mapFilterType);
                    
                    let matchDistance = true;
                    if (mapFilterDistance !== 'all') {
                         const dist = getDistance(shop.lat, shop.lng, currentCenter.lat, currentCenter.lng);
                         if (mapFilterDistance === 'near') {
                             matchDistance = dist <= 1;
                         } else if (mapFilterDistance === 'far') {
                             matchDistance = dist > 1;
                         }
                    }

                    // 特徵篩選
                    let matchSpecial = true;
                    if (mapFilterSpecial.length > 0) {
                        const isWagyu = checkIsWagyu(shop);
                        const selectWagyu = mapFilterSpecial.includes('wagyu');
                        const selectOtherFeature = mapFilterSpecial.includes('other_feature');

                        if (selectWagyu) {
                            matchSpecial = isWagyu;
                        } else if (selectOtherFeature) {
                            matchSpecial = !isWagyu;
                        }
                    }

                    return matchLocation && matchType && matchDistance && matchSpecial;
                });
            }, [allShopsForMap, mapCategory, mapFilterType, mapFilterDistance, currentCenter, mapFilterSpecial]);

            // 處理特殊篩選點擊 (互斥)
            const handleSpecialFilterClick = (id) => {
                let newSelection;
                if (mapFilterSpecial.includes(id)) {
                    newSelection = [];
                } else {
                    newSelection = [id];
                }
                setMapFilterSpecial(newSelection);
            };

            const goToMap = (category) => {
                setMapCategory(category);
                setActiveTab('map');
            };

            const shopsToList = listTab === 'my' ? userShops : SYSTEM_SHOPS;
            const displayList = listTab === 'my' ? [...shopsToList] : [...shopsToList]; 
            const totalPages = Math.ceil(displayList.length / ITEMS_PER_PAGE) || 1;
            
            useEffect(() => {
                setCurrentPage(1);
            }, [listTab]);

            const currentShops = displayList.slice((currentPage - 1) * ITEMS_PER_PAGE, currentPage * ITEMS_PER_PAGE);

            return (
                <div className="flex flex-col h-screen">
                    <header className="bg-white shadow-sm p-4 pt-safe-top z-10 sticky top-0 relative">
                        {activeTab === 'map' && (
                            <button 
                                onClick={() => setActiveTab('add')}
                                className="absolute left-2 top-1/2 -translate-y-1/2 p-2 text-gray-600 hover:text-blue-600 active:scale-90 transition-transform"
                                aria-label="返回"
                            >
                                <IconArrowLeft />
                            </button>
                        )}
                        <h1 className="text-xl font-bold text-center text-gray-800 flex items-center justify-center gap-2">
                            <span className="text-blue-600"><IconMapPin className="w-6 h-6"/></span>
                            美食特輯地圖 京阪ver.
                        </h1>
                    </header>

                    <main className="flex-1 overflow-hidden relative">
                        {activeTab === 'add' && (
                            <div className="h-full overflow-y-auto p-4 max-w-md mx-auto">
                                <div className="bg-white p-4 rounded-xl shadow-sm mb-6">
                                    <div className="mb-3">
                                        <label className="block text-sm font-medium text-gray-700 mb-2">選擇美食類別 (可複選)</label>
                                        <div className="flex flex-wrap gap-2">
                                            {FOOD_TYPES.map(t => (
                                                <button
                                                    key={t.id}
                                                    onClick={() => handleInputTypeClick(t.id)}
                                                    className={`px-3 py-1.5 rounded-full text-xs font-medium border transition-colors ${
                                                        inputType.includes(t.id)
                                                            ? 'bg-black text-white border-black'
                                                            : 'bg-gray-50 text-gray-600 border-gray-200 hover:bg-gray-100'
                                                    }`}
                                                >
                                                    {t.label}
                                                </button>
                                            ))}
                                        </div>
                                    </div>

                                    <label className="block text-sm font-medium text-gray-700 mb-2">輸入店鋪名稱</label>
                                    
                                    <div className="flex gap-2">
                                        <input
                                            type="text"
                                            value={inputName}
                                            onChange={(e) => setInputName(e.target.value)}
                                            placeholder="例：一蘭拉麵(必點豚骨)"
                                            className="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                                            onKeyDown={(e) => e.key === 'Enter' && handleAddShop()}
                                        />
                                        <button
                                            onClick={handleAddShop}
                                            disabled={loading}
                                            className="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700 disabled:bg-gray-400 transition-colors flex items-center justify-center min-w-[50px]"
                                        >
                                            {loading ? (
                                                <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                                            ) : (
                                                <IconSearch />
                                            )}
                                        </button>
                                    </div>

                                    {error && <p className="text-red-500 text-sm mt-2">{error}</p>}
                                </div>

                                <div className="grid grid-cols-2 gap-4 mb-6">
                                    <button 
                                        onClick={() => goToMap('kyoto')}
                                        className="bg-indigo-50 p-4 rounded-xl border border-indigo-100 text-center hover:bg-indigo-100 transition-colors btn-active group"
                                    >
                                        <h3 className="text-indigo-800 font-bold text-lg">京都附近</h3>
                                        <p className="text-3xl font-black text-indigo-600 mb-2">
                                            {allShopsForMap.filter(s => s.category === 'kyoto').length}
                                        </p>
                                        <div className="text-xs text-indigo-500 font-bold flex items-center justify-center gap-1 opacity-80 group-hover:opacity-100">
                                            <span>查看地圖</span>
                                            <IconArrowRight />
                                        </div>
                                    </button>
                                    
                                    <button 
                                        onClick={() => goToMap('osaka')}
                                        className="bg-rose-50 p-4 rounded-xl border border-rose-100 text-center hover:bg-rose-100 transition-colors btn-active group"
                                    >
                                        <h3 className="text-rose-800 font-bold text-lg">大阪附近</h3>
                                        <p className="text-3xl font-black text-rose-600 mb-2">
                                            {allShopsForMap.filter(s => s.category === 'osaka').length}
                                        </p>
                                        <div className="text-xs text-rose-500 font-bold flex items-center justify-center gap-1 opacity-80 group-hover:opacity-100">
                                            <span>查看地圖</span>
                                            <IconArrowRight />
                                        </div>
                                    </button>
                                </div>

                                <div className="flex items-center justify-between mb-3 border-b border-gray-200">
                                    <div className="flex gap-4">
                                        <button
                                            onClick={() => setListTab('my')}
                                            className={`pb-2 text-sm font-bold uppercase tracking-wider transition-colors border-b-2 ${
                                                listTab === 'my' 
                                                    ? 'text-blue-600 border-blue-600' 
                                                    : 'text-gray-400 border-transparent hover:text-gray-600'
                                            }`}
                                        >
                                            我的店鋪
                                        </button>
                                        <button
                                            onClick={() => setListTab('system')}
                                            className={`pb-2 text-sm font-bold uppercase tracking-wider transition-colors border-b-2 ${
                                                listTab === 'system' 
                                                    ? 'text-purple-600 border-purple-600' 
                                                    : 'text-gray-400 border-transparent hover:text-gray-600'
                                            }`}
                                        >
                                            系統推薦
                                        </button>
                                    </div>
                                    <button
                                        onClick={() => setShowList(!showList)}
                                        className="text-gray-400 hover:text-gray-600 p-1 rounded-full hover:bg-gray-100 transition-colors mb-1"
                                        aria-label={showList ? "收起列表" : "展開列表"}
                                    >
                                        {showList ? <IconChevronUp /> : <IconChevronDown />}
                                    </button>
                                </div>

                                {showList && (
                                    <div className="space-y-3 pb-6">
                                        {currentShops.length === 0 ? (
                                            <div className="text-center py-10 text-gray-400">
                                                <p>{listTab === 'my' ? '還沒有收藏任何店舖' : '暫無推薦店鋪'}</p>
                                            </div>
                                        ) : (
                                            currentShops.map(shop => {
                                                const labels = getFoodTypeLabels(shop.type);
                                                const isWagyu = checkIsWagyu(shop);
                                                return (
                                                    <div key={shop.id} className="bg-white p-4 rounded-lg shadow-sm border border-gray-100 flex justify-between items-center group">
                                                        <div className="flex-1 min-w-0 pr-2">
                                                            <h4 className="font-bold text-gray-800 break-words whitespace-pre-wrap text-sm leading-snug flex items-center gap-2">
                                                                {shop.name}
                                                            </h4>
                                                            <div className="flex items-center gap-2 mt-1 flex-wrap">
                                                                {/* 系統推薦星星移到這裡 */}
                                                                {listTab === 'system' && <IconStar className="text-yellow-400 w-3 h-3 flex-shrink-0"/>}
                                                                <span className={`text-xs px-2 py-0.5 rounded-full text-white shrink-0 ${shop.category === 'kyoto' ? 'bg-indigo-500' : 'bg-rose-500'}`}>
                                                                    {shop.category === 'kyoto' ? '京都' : '大阪'}
                                                                </span>
                                                                {labels.map((label, idx) => (
                                                                    <span key={idx} className="text-xs px-2 py-0.5 rounded-full bg-gray-100 text-gray-600 border border-gray-200 shrink-0">
                                                                        {label}
                                                                    </span>
                                                                ))}
                                                                {/* 僅在符合和牛特徵時顯示和牛標籤 */}
                                                                {isWagyu && (
                                                                    <span className="text-xs px-2 py-0.5 rounded-full bg-orange-100 text-orange-800 border border-orange-200 shrink-0">
                                                                        和牛
                                                                    </span>
                                                                )}
                                                            </div>
                                                            <p className="text-xs text-gray-500 truncate mt-1">{shop.displayName}</p>
                                                        </div>
                                                        
                                                        {listTab === 'my' && (
                                                            <button 
                                                                onClick={() => handleDelete(shop.id)}
                                                                className="text-gray-400 hover:text-red-500 p-2 shrink-0"
                                                            >
                                                                <IconTrash />
                                                            </button>
                                                        )}
                                                    </div>
                                                );
                                            })
                                        )}

                                        {displayList.length > ITEMS_PER_PAGE && (
                                            <div className="flex justify-center items-center gap-4 pt-2">
                                                <button 
                                                    disabled={currentPage === 1}
                                                    onClick={() => setCurrentPage(p => Math.max(1, p - 1))}
                                                    className="p-1 rounded-full hover:bg-gray-100 disabled:opacity-30 transition-colors text-gray-600"
                                                >
                                                    <IconChevronLeft />
                                                </button>
                                                <span className="text-xs text-gray-500 font-medium">
                                                    {currentPage} / {totalPages}
                                                </span>
                                                <button 
                                                    disabled={currentPage === totalPages}
                                                    onClick={() => setCurrentPage(p => Math.min(totalPages, p + 1))}
                                                    className="p-1 rounded-full hover:bg-gray-100 disabled:opacity-30 transition-colors text-gray-600"
                                                >
                                                    <IconChevronRight />
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                )}

                                {listTab === 'my' && (
                                    <div className="pt-6 pb-20 border-t border-gray-200 text-center">
                                        <button 
                                            onClick={handleExport}
                                            className="inline-flex items-center gap-2 text-gray-500 hover:text-gray-700 bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-full text-sm font-medium transition-colors"
                                        >
                                            <IconDownload />
                                            輸出個人紀錄
                                        </button>
                                        <p className="text-xs text-gray-400 mt-2">
                                            點擊複製資料，可用於備份或貼回程式碼中
                                        </p>
                                    </div>
                                )}
                                {listTab === 'system' && (
                                    <div className="pb-20 text-center text-xs text-gray-400 pt-4">
                                        系統推薦店鋪無法刪除或修改
                                    </div>
                                )}
                            </div>
                        )}

                        {activeTab === 'map' && (
                            <div className="h-full flex flex-col">
                                {/* 第一層：地區選擇 */}
                                <div className="flex p-2 gap-2 bg-white shadow-sm z-20 shrink-0">
                                    <button
                                        onClick={() => setMapCategory('kyoto')}
                                        className={`flex-1 py-3 rounded-lg font-bold transition-all ${
                                            mapCategory === 'kyoto' 
                                                ? 'bg-indigo-600 text-white shadow-md transform scale-[1.02]' 
                                                : 'bg-gray-100 text-gray-500 hover:bg-gray-200'
                                        }`}
                                    >
                                        京都附近
                                    </button>
                                    <button
                                        onClick={() => setMapCategory('osaka')}
                                        className={`flex-1 py-3 rounded-lg font-bold transition-all ${
                                            mapCategory === 'osaka' 
                                                ? 'bg-rose-600 text-white shadow-md transform scale-[1.02]' 
                                                : 'bg-gray-100 text-gray-500 hover:bg-gray-200'
                                        }`}
                                    >
                                        大阪附近
                                    </button>
                                </div>

                                {/* 第二層 A：大阪子地點選單 (只在選擇大阪時顯示) */}
                                {mapCategory === 'osaka' && (
                                    <div className="bg-rose-50 border-b border-rose-100 px-2 py-2 flex gap-2 shrink-0 z-10">
                                        {Object.values(OSAKA_SUBLOCATIONS).map(loc => (
                                            <button
                                                key={loc.id}
                                                onClick={() => setOsakaSubLocation(loc.id)}
                                                className={`flex-1 py-1.5 rounded-full text-xs font-bold transition-colors border ${
                                                    osakaSubLocation === loc.id
                                                        ? 'bg-rose-600 text-white border-rose-600'
                                                        : 'bg-white text-rose-600 border-rose-200 hover:bg-rose-100'
                                                }`}
                                            >
                                                {loc.name}
                                            </button>
                                        ))}
                                    </div>
                                )}

                                {/* 詳細選單開關區塊 (包含計數文字) */}
                                <div className="w-full bg-gray-50 border-b border-gray-200 py-1 flex items-center justify-center relative z-10">
                                    <span className="text-xs font-bold text-gray-500 mr-4">
                                        共發現 {filteredShops.length} 家店鋪
                                    </span>
                                    <button
                                        onClick={() => setIsDetailMenuOpen(!isDetailMenuOpen)}
                                        className="flex items-center gap-1 text-xs text-gray-500 hover:bg-gray-100 transition-colors px-2 py-1 rounded"
                                    >
                                        <span>詳細選單</span>
                                        {isDetailMenuOpen ? <IconChevronUp /> : <IconChevronDown />}
                                    </button>
                                </div>

                                {/* 可收折的詳細篩選選單 (含動畫) */}
                                <div className={`accordion-content bg-white shadow-sm z-10 ${isDetailMenuOpen ? 'open' : ''}`}>
                                    {/* 第二層 B：距離篩選 */}
                                    <div className="border-b border-gray-100 px-2 pb-2 pt-2 flex gap-2 justify-center">
                                        {DISTANCE_TYPES.map(d => (
                                            <button
                                                key={d.id}
                                                onClick={() => setMapFilterDistance(d.id)}
                                                className={`px-3 py-1 rounded-md text-xs font-bold transition-colors border ${
                                                    mapFilterDistance === d.id
                                                        ? 'bg-green-200 text-green-900 border-green-300'
                                                        : 'bg-white text-gray-500 border-gray-200 hover:bg-gray-50'
                                                }`}
                                            >
                                                {d.label}
                                            </button>
                                        ))}
                                    </div>

                                    {/* 第二層 C：種類篩選 (水平捲動) */}
                                    <div className="border-b border-gray-100 px-2 py-2 flex gap-2 overflow-x-auto scrollbar-hide items-center">
                                        {FILTER_TYPES.map(t => (
                                            <button
                                                key={t.id}
                                                onClick={() => setMapFilterType(t.id)}
                                                className={`px-4 py-1.5 rounded-full text-xs font-bold transition-colors border shrink-0 ${
                                                    mapFilterType === t.id
                                                        ? 'bg-black text-white border-black'
                                                        : 'bg-white text-gray-500 border-gray-200 hover:bg-gray-100'
                                                }`}
                                            >
                                                {t.label}
                                            </button>
                                        ))}
                                    </div>

                                    {/* 第二層 D：特殊特徵篩選 (和牛/其它) - 移到最下方 */}
                                    <div className="border-b border-gray-100 px-2 pb-2 pt-2 flex gap-2 justify-center">
                                        {SPECIAL_TYPES.map(s => (
                                            <button
                                                key={s.id}
                                                onClick={() => handleSpecialFilterClick(s.id)}
                                                className={`px-3 py-1 rounded-md text-xs font-bold transition-colors border ${
                                                    mapFilterSpecial.includes(s.id)
                                                        ? 'bg-orange-200 text-orange-900 border-orange-400'
                                                        : 'bg-white text-gray-500 border-gray-200 hover:bg-gray-50'
                                                }`}
                                            >
                                                {s.label}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                                
                                <div className="flex-1 relative z-0">
                                    <MapView 
                                        center={currentCenter} 
                                        shops={filteredShops} 
                                    />
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
