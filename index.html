<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>京阪店鋪收納地圖</title>
    
    <!-- iOS PWA 專用設定 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="京阪探店">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/854/854878.png">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- React & ReactDOM & Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>

    <style>
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .leaflet-container { width: 100%; height: 100%; z-index: 0; }
        body { overscroll-behavior-y: none; -webkit-tap-highlight-color: transparent; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans h-screen w-screen overflow-hidden">
    <div id="root" class="h-full w-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Icons ---
        const IconSearch = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>;
        const IconMapPin = ({className}) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>;
        const IconTrash = () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>;
        const IconMap = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"></polygon><line x1="8" y1="2" x2="8" y2="18"></line><line x1="16" y1="6" x2="16" y2="22"></line></svg>;
        const IconList = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>;

        // --- Constants ---
        const LOCATIONS = {
            kyoto: { name: "京都車站", lat: 34.9858, lng: 135.7588, color: "bg-indigo-600" },
            osaka: { name: "大阪梅田", lat: 34.7025, lng: 135.4958, color: "bg-rose-600" }
        };

        // --- Helper: Distance Calculation ---
        const getDistance = (lat1, lon1, lat2, lon2) => {
            const R = 6371; 
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2); 
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
            return R * c;
        };

        // --- Component: MapView (Updated Logic) ---
        function MapView({ center, shops, mapCategory }) {
            const mapContainerRef = useRef(null);
            const mapInstanceRef = useRef(null);
            const markersRef = useRef([]);

            // 1. 初始化地圖 (只執行一次)
            useEffect(() => {
                if (!mapContainerRef.current) return;
                
                // 修正圖標路徑
                delete L.Icon.Default.prototype._getIconUrl;
                L.Icon.Default.mergeOptions({
                    iconRetinaUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png',
                    iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
                    shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
                });

                // 初始化地圖，先設定到中心點
                const map = L.map(mapContainerRef.current).setView([center.lat, center.lng], 13);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; OpenStreetMap contributors'
                }).addTo(map);

                // 添加中心點標記 (車站)
                const centerIcon = new L.Icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-gold.png',
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34],
                    shadowSize: [41, 41]
                });

                L.marker([center.lat, center.lng], { icon: centerIcon })
                    .bindPopup(`<b>${center.name}</b> (中心)`)
                    .addTo(map);

                mapInstanceRef.current = map;

                return () => {
                    map.remove();
                    mapInstanceRef.current = null;
                };
            }, []); 

            // 2. 當地點或店鋪清單改變時：更新標記 + 自動縮放視角 (FitBounds)
            useEffect(() => {
                if (!mapInstanceRef.current) return;
                const map = mapInstanceRef.current;

                // 更新中心點標記位置
                map.eachLayer((layer) => {
                    if (layer instanceof L.Marker && layer.getIcon().options.iconUrl.includes('gold')) {
                         layer.setLatLng([center.lat, center.lng])
                              .setPopupContent(`<b>${center.name}</b> (中心)`)
                              .openPopup();
                    }
                });

                // 清除舊的店鋪標記
                markersRef.current.forEach(m => m.remove());
                markersRef.current = [];

                // 收集所有座標點（包含中心點）以便計算邊界
                const points = [[center.lat, center.lng]];

                // 添加新的店鋪標記
                shops.forEach(shop => {
                    points.push([shop.lat, shop.lng]);

                    const popupContent = `
                        <div class="p-1">
                            <h3 class="font-bold text-base mb-1">${shop.name}</h3>
                            <p class="text-xs text-gray-600 mb-2">${shop.address || '無地址資訊'}</p>
                            <a href="https://maps.google.com/?q=${shop.lat},${shop.lng}" 
                               target="_blank" 
                               style="color: #2563eb; text-decoration: none; font-size: 12px; display: flex; align-items: center; gap: 4px;">
                               ➤ 開啟 Google Maps 導航
                            </a>
                        </div>
                    `;

                    const marker = L.marker([shop.lat, shop.lng])
                        .bindPopup(popupContent)
                        .addTo(map);
                    markersRef.current.push(marker);
                });

                // 自動縮放邏輯
                if (shops.length > 0) {
                    // 如果有店鋪，計算包含所有點的邊界框 (Bounds)
                    const bounds = L.latLngBounds(points);
                    // 調整地圖以符合該邊界框
                    map.fitBounds(bounds, {
                        padding: [50, 50], // 上下左右保留 50px 緩衝區，避免標記貼在螢幕邊緣
                        maxZoom: 16,       // 最大縮放層級，避免只有一個點時放太大
                        animate: true,
                        duration: 1.0
                    });
                } else {
                    // 如果沒有店鋪，平滑移動回中心點，固定 Zoom 13
                    map.flyTo([center.lat, center.lng], 13, { duration: 1.0 });
                }

            }, [center, shops]);

            return <div ref={mapContainerRef} className="h-full w-full"></div>;
        }

        // --- Main App Component ---
        function App() {
            // 從 LocalStorage 讀取資料 (保留使用者輸入紀錄)
            const [shops, setShops] = useState(() => {
                const saved = localStorage.getItem('kansai_shops');
                return saved ? JSON.parse(saved) : [];
            });
            const [inputName, setInputName] = useState('');
            const [activeTab, setActiveTab] = useState('add');
            const [mapCategory, setMapCategory] = useState('kyoto');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);

            useEffect(() => {
                localStorage.setItem('kansai_shops', JSON.stringify(shops));
            }, [shops]);

            const handleAddShop = async () => {
                if (!inputName.trim()) return;
                setLoading(true);
                setError(null);

                try {
                    const response = await fetch(
                        `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(inputName + ' 日本')}&limit=1`
                    );
                    const data = await response.json();

                    if (data && data.length > 0) {
                        const place = data[0];
                        const lat = parseFloat(place.lat);
                        const lng = parseFloat(place.lon);

                        const distToKyoto = getDistance(lat, lng, LOCATIONS.kyoto.lat, LOCATIONS.kyoto.lng);
                        const distToOsaka = getDistance(lat, lng, LOCATIONS.osaka.lat, LOCATIONS.osaka.lng);
                        
                        const category = distToKyoto < distToOsaka ? 'kyoto' : 'osaka';

                        const newShop = {
                            id: Date.now(),
                            name: inputName,
                            displayName: place.display_name.split(',')[0],
                            lat,
                            lng,
                            category,
                            address: place.display_name
                        };

                        setShops([newShop, ...shops]);
                        setInputName('');
                    } else {
                        setError('找不到該店舖，請嘗試更精確的名稱（例如加上地區名）。');
                    }
                } catch (err) {
                    setError('搜尋時發生錯誤，請檢查網路連線。');
                } finally {
                    setLoading(false);
                }
            };

            const handleDelete = (id) => {
                setShops(shops.filter(shop => shop.id !== id));
            };

            const filteredShops = useMemo(() => {
                return shops.filter(shop => shop.category === mapCategory);
            }, [shops, mapCategory]);

            return (
                <div className="flex flex-col h-screen">
                    {/* Header */}
                    <header className="bg-white shadow-sm p-4 pt-safe-top z-10 sticky top-0">
                        <h1 className="text-xl font-bold text-center text-gray-800 flex items-center justify-center gap-2">
                            <span className="text-blue-600"><IconMapPin className="w-6 h-6"/></span>
                            京阪探店地圖
                        </h1>
                    </header>

                    {/* Main Content */}
                    <main className="flex-1 overflow-hidden relative">
                        {/* Tab 1: Add List */}
                        {activeTab === 'add' && (
                            <div className="h-full overflow-y-auto p-4 max-w-md mx-auto">
                                <div className="bg-white p-4 rounded-xl shadow-sm mb-6">
                                    <label className="block text-sm font-medium text-gray-700 mb-2">輸入想去的店舖名稱</label>
                                    <div className="flex gap-2">
                                        <input
                                            type="text"
                                            value={inputName}
                                            onChange={(e) => setInputName(e.target.value)}
                                            placeholder="例：清水寺、一蘭拉麵 梅田店"
                                            className="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                                            onKeyDown={(e) => e.key === 'Enter' && handleAddShop()}
                                        />
                                        <button
                                            onClick={handleAddShop}
                                            disabled={loading}
                                            className="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700 disabled:bg-gray-400 transition-colors flex items-center justify-center min-w-[50px]"
                                        >
                                            {loading ? (
                                                <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                                            ) : (
                                                <IconSearch />
                                            )}
                                        </button>
                                    </div>
                                    {error && <p className="text-red-500 text-sm mt-2">{error}</p>}
                                </div>

                                <div className="grid grid-cols-2 gap-4 mb-6">
                                    <div className="bg-indigo-50 p-4 rounded-xl border border-indigo-100 text-center">
                                        <h3 className="text-indigo-800 font-bold text-lg">京都附近</h3>
                                        <p className="text-3xl font-black text-indigo-600">
                                            {shops.filter(s => s.category === 'kyoto').length}
                                        </p>
                                        <span className="text-xs text-indigo-400">店舖數量</span>
                                    </div>
                                    <div className="bg-rose-50 p-4 rounded-xl border border-rose-100 text-center">
                                        <h3 className="text-rose-800 font-bold text-lg">大阪附近</h3>
                                        <p className="text-3xl font-black text-rose-600">
                                            {shops.filter(s => s.category === 'osaka').length}
                                        </p>
                                        <span className="text-xs text-rose-400">店舖數量</span>
                                    </div>
                                </div>

                                <h3 className="text-gray-500 text-sm font-bold mb-3 uppercase tracking-wider">最近新增</h3>
                                <div className="space-y-3 pb-20">
                                    {shops.length === 0 ? (
                                        <div className="text-center py-10 text-gray-400">
                                            <p>還沒有收藏任何店舖</p>
                                            <p className="text-sm">試著搜尋並加入吧！</p>
                                        </div>
                                    ) : (
                                        [...shops].reverse().map(shop => (
                                            <div key={shop.id} className="bg-white p-4 rounded-lg shadow-sm border border-gray-100 flex justify-between items-center group">
                                                <div className="flex-1 min-w-0 pr-2">
                                                    <h4 className="font-bold text-gray-800 truncate">{shop.name}</h4>
                                                    <div className="flex items-center gap-2 mt-1">
                                                        <span className={`text-xs px-2 py-0.5 rounded-full text-white shrink-0 ${shop.category === 'kyoto' ? 'bg-indigo-500' : 'bg-rose-500'}`}>
                                                            {shop.category === 'kyoto' ? '京都圈' : '大阪圈'}
                                                        </span>
                                                        <p className="text-xs text-gray-500 truncate">{shop.displayName}</p>
                                                    </div>
                                                </div>
                                                <button 
                                                    onClick={() => handleDelete(shop.id)}
                                                    className="text-gray-400 hover:text-red-500 p-2 shrink-0"
                                                >
                                                    <IconTrash />
                                                </button>
                                            </div>
                                        ))
                                    )}
                                </div>
                            </div>
                        )}

                        {/* Tab 2: Map Mode */}
                        {activeTab === 'map' && (
                            <div className="h-full flex flex-col">
                                <div className="flex p-2 gap-2 bg-white shadow-sm z-10 shrink-0">
                                    <button
                                        onClick={() => setMapCategory('kyoto')}
                                        className={`flex-1 py-3 rounded-lg font-bold transition-all ${
                                            mapCategory === 'kyoto' 
                                                ? 'bg-indigo-600 text-white shadow-md transform scale-[1.02]' 
                                                : 'bg-gray-100 text-gray-500 hover:bg-gray-200'
                                        }`}
                                    >
                                        京都附近
                                    </button>
                                    <button
                                        onClick={() => setMapCategory('osaka')}
                                        className={`flex-1 py-3 rounded-lg font-bold transition-all ${
                                            mapCategory === 'osaka' 
                                                ? 'bg-rose-600 text-white shadow-md transform scale-[1.02]' 
                                                : 'bg-gray-100 text-gray-500 hover:bg-gray-200'
                                        }`}
                                    >
                                        大阪附近
                                    </button>
                                </div>
                                
                                <div className="flex-1 relative z-0">
                                    <MapView 
                                        center={LOCATIONS[mapCategory]} 
                                        shops={filteredShops} 
                                        mapCategory={mapCategory}
                                    />
                                </div>
                            </div>
                        )}
                    </main>

                    {/* Bottom Nav */}
                    <nav className="bg-white border-t border-gray-200 pb-safe z-20">
                        <div className="flex justify-around items-center h-16">
                            <button
                                onClick={() => setActiveTab('add')}
                                className={`flex flex-col items-center justify-center w-full h-full space-y-1 ${
                                    activeTab === 'add' ? 'text-blue-600' : 'text-gray-400'
                                }`}
                            >
                                <IconList />
                                <span className="text-xs font-medium">我的清單</span>
                            </button>
                            
                            <button
                                onClick={() => setActiveTab('map')}
                                className={`flex flex-col items-center justify-center w-full h-full space-y-1 ${
                                    activeTab === 'map' ? 'text-blue-600' : 'text-gray-400'
                                }`}
                            >
                                <IconMap />
                                <span className="text-xs font-medium">查看地圖</span>
                            </button>
                        </div>
                    </nav>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
